# Sprint 1 - npm è­¦å‘Šåˆ†æå’Œå¤„ç†å»ºè®®

**æ—¥æœŸ**: 2026-01-25  
**åœºæ™¯**: Story 2.2 - å®‰è£… bcrypt, class-validator, class-transformer ä¾èµ–

## ğŸ“‹ é—®é¢˜æ€»ç»“

å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°ä»¥ä¸‹è­¦å‘Šï¼š

### 1. Deprecated Packagesï¼ˆå·²å¼ƒç”¨çš„åŒ…ï¼‰
- `glob@7.2.3` - éœ€è¦å‡çº§è‡³ v9+
- `gauge@3.0.2` - ä¸å†æ”¯æŒ
- `are-we-there-yet@2.0.0` - ä¸å†æ”¯æŒ  
- `tar@6.2.1` - å­˜åœ¨å·²çŸ¥å®‰å…¨æ¼æ´
- `rimraf@3.0.2` - éœ€è¦å‡çº§è‡³ v4+
- `npmlog@5.0.1` - ä¸å†æ”¯æŒ

### 2. Security Vulnerabilitiesï¼ˆå®‰å…¨æ¼æ´ï¼‰
```
5 vulnerabilities (2 moderate, 3 high)
- 2 moderate: lodash (Prototype Pollution)
- 3 high: tar (Path Sanitization, Race Condition), bcrypt (via @mapbox/node-pre-gyp)
```

---

## ğŸ” è¯¦ç»†åˆ†æ

### A. Deprecated Packagesï¼ˆå·²å¼ƒç”¨åŒ… - ä½ä¼˜å…ˆçº§ï¼‰

**æ€§è´¨**: è¿™äº›éƒ½æ˜¯ **é—´æ¥ä¾èµ–**ï¼ˆtransitive dependenciesï¼‰ï¼Œä¸æ˜¯æˆ‘ä»¬ç›´æ¥å®‰è£…çš„ã€‚

**æ¥æº**:
- `tar`, `gauge`, `are-we-there-yet`, `npmlog`, `rimraf` â† æ¥è‡ª `bcrypt` çš„ä¾èµ– `@mapbox/node-pre-gyp`
- `glob` â† å¯èƒ½æ¥è‡ªå¤šä¸ªåŒ…

**é£é™©è¯„ä¼°**: âš ï¸ **ä½é£é™©**
- è¿™äº›åŒ…ä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ
- è­¦å‘Šæ˜¯æé†’ä¸Šæ¸¸åŒ…ï¼ˆbcryptï¼‰éœ€è¦æ›´æ–°å…¶ä¾èµ–
- å¯¹æˆ‘ä»¬çš„åº”ç”¨åŠŸèƒ½æ²¡æœ‰ç›´æ¥å½±å“

**å»ºè®®**: âœ… **æš‚æ—¶å¿½ç•¥**
- ç­‰å¾… bcrypt å›¢é˜Ÿå‘å¸ƒæ–°ç‰ˆæœ¬æ›´æ–°è¿™äº›ä¾èµ–
- è¿™ä¸æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥æ§åˆ¶çš„

---

### B. Security Vulnerabilitiesï¼ˆå®‰å…¨æ¼æ´ - éœ€è¦è¯„ä¼°ï¼‰

#### 1. lodash - 2 moderate (å·²çŸ¥é—®é¢˜)

```
æ¼æ´: Prototype Pollution in _.unset and _.omit
ä¸¥é‡æ€§: Moderate
CVSS: 6.5
å½±å“èŒƒå›´: @nestjs/config >= 1.1.6
```

**çŠ¶æ€**: âœ… **å·²åœ¨ ADR-002 ä¸­æ¥å—é£é™©**
- è¿™æ˜¯æˆ‘ä»¬åœ¨ Sprint 1 å‡†å¤‡é˜¶æ®µå·²ç»åˆ†æè¿‡çš„æ¼æ´
- å†³ç­–: æ¥å—é£é™©è‡³ Sprint 8ï¼ˆç†ç”±è§ `docs/decisions/002-lodash-security-risk-acceptance.md`ï¼‰
- ç›‘æ§è®¡åˆ’: æ¯å‘¨æ£€æŸ¥æ¼æ´çŠ¶æ€

**æ— éœ€é‡‡å–è¡ŒåŠ¨** - å·²æœ‰é£é™©ç®¡ç†ç­–ç•¥

---

#### 2. tar - 2 high âš ï¸ **æ–°å‘ç°ï¼Œéœ€è¦å…³æ³¨**

```
æ¼æ´ 1: Arbitrary File Overwrite and Symlink Poisoning
æ¼æ´ 2: Race Condition via Unicode Ligature Collisions (macOS APFS)
ä¸¥é‡æ€§: High
å½±å“èŒƒå›´: tar <= 7.5.3
GHSA-8qq5-rm4j-mr97, GHSA-r6q2-hw4h-h46w
```

**ä¾èµ–é“¾**:
```
bcrypt@5.1.1
  â””â”€â”€ @mapbox/node-pre-gyp <= 1.0.11
      â””â”€â”€ tar <= 7.5.3 (vulnerable)
```

**é£é™©è¯„ä¼°**: âš ï¸ **ä¸­ç­‰é£é™©**

**å®é™…å½±å“åˆ†æ**:
- `tar` è¢« `bcrypt` çš„æ„å»ºå·¥å…· `node-pre-gyp` ä½¿ç”¨
- ç”¨é€”: åœ¨ npm install æ—¶è§£å‹é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶
- **ä»…åœ¨å®‰è£…é˜¶æ®µè¿è¡Œï¼Œä¸ä¼šåœ¨åº”ç”¨è¿è¡Œæ—¶æ‰§è¡Œ**
- æ¼æ´éœ€è¦æ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶è§£å‹çš„ tar æ–‡ä»¶å†…å®¹

**å¼€å‘ç¯å¢ƒç¼“è§£å› ç´ **:
- âœ… æˆ‘ä»¬ä»å®˜æ–¹ npm registry å®‰è£…ï¼ˆå¯ä¿¡æºï¼‰
- âœ… Azure DevOps æ„å»ºç¯å¢ƒæ˜¯éš”ç¦»çš„
- âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒæ²¡æœ‰å¤–éƒ¨æ”»å‡»é¢
- âŒ æ¼æ´åœ¨æ„å»º/CI ç¯å¢ƒä¸­ç†è®ºä¸Šå¯è¢«åˆ©ç”¨ï¼ˆå¦‚æœ npm åŒ…è¢«æ±¡æŸ“ï¼‰

---

#### 3. bcrypt - 1 high âš ï¸ **é—´æ¥æ¼æ´**

```
ä¸¥é‡æ€§: High
å½±å“èŒƒå›´: bcrypt 5.0.1 - 5.1.1
```

**æ³¨æ„**: è¿™ä¸æ˜¯ bcrypt æœ¬èº«çš„æ¼æ´ï¼Œè€Œæ˜¯é€šè¿‡ `@mapbox/node-pre-gyp` â†’ `tar` é“¾ä¼ é€’çš„æ¼æ´ã€‚

---

## ğŸ’¡ å¤„ç†å»ºè®®

### æ¨èæ–¹æ¡ˆ: **æ¥å—é£é™© + ç›‘æ§** âœ…

**ç†ç”±**:

1. **lodash**: å·²æœ‰ ADR-002 é£é™©ç®¡ç†ç­–ç•¥
2. **tar/bcrypt**: 
   - æ¼æ´ä»…å½±å“å®‰è£…é˜¶æ®µï¼Œä¸å½±å“è¿è¡Œæ—¶
   - æˆ‘ä»¬ä½¿ç”¨å¯ä¿¡çš„åŒ…æºï¼ˆnpm å®˜æ–¹ registryï¼‰
   - å¼€å‘ç¯å¢ƒé£é™©å¯æ§
   - ç”Ÿäº§ç¯å¢ƒå°†ä½¿ç”¨é”å®šçš„ä¾èµ–ç‰ˆæœ¬

3. **npm audit fix --force çš„é£é™©**:
   ```
   Will install @nestjs/config@1.1.5 (breaking change)
   Will install bcrypt@6.0.0 (breaking change)
   ```
   - ä¼šé™çº§ @nestjs/configï¼ˆå¯èƒ½ç ´åé…ç½®åŠŸèƒ½ï¼‰
   - ä¼šå‡çº§ bcrypt åˆ° v6ï¼ˆå¯èƒ½æœ‰ breaking changesï¼‰
   - **ä¸å»ºè®®åœ¨ Sprint 1 ä¸­æœŸæ‰§è¡Œ**

---

## ğŸ¯ è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆSprint 1ï¼‰

**1. æ›´æ–°é£é™©æ–‡æ¡£**
- å°† tar æ¼æ´æ·»åŠ åˆ° `sprint-1-tech-stack-verification.md`
- è®°å½•æ¥å—é£é™©çš„å†³ç­–å’Œç†ç”±

**2. æ·»åŠ åˆ° ADR-002 ç›‘æ§è®¡åˆ’**
- åœ¨æ¯å‘¨æ¼æ´æ£€æŸ¥ä¸­åŒ…å« tar æ¼æ´
- å…³æ³¨ bcrypt å’Œ @mapbox/node-pre-gyp çš„æ›´æ–°

**3. é”å®šä¾èµ–ç‰ˆæœ¬**
- ç¡®ä¿ package-lock.json å·²æäº¤ï¼ˆâœ… å·²å®Œæˆï¼‰
- ç”Ÿäº§æ„å»ºä½¿ç”¨ `npm ci` è€Œé `npm install`

### Sprint 2-3 è¯„ä¼°

**1. ç›‘æ§ä¸Šæ¸¸æ›´æ–°**
- å…³æ³¨ bcrypt v6.0+ ç¨³å®šæ€§
- å…³æ³¨ @nestjs/config v4.x çš„ lodash ä¾èµ–ç§»é™¤æƒ…å†µ

**2. è€ƒè™‘æ›¿ä»£æ–¹æ¡ˆ**
- å¦‚æœ bcrypt v6 ç¨³å®šï¼Œè¯„ä¼°å‡çº§ï¼ˆéœ€è¦æµ‹è¯•ï¼‰
- å¦‚æœ @mapbox/node-pre-gyp æ›´æ–°ä¿®å¤ tar æ¼æ´ï¼Œç­‰å¾… bcrypt é›†æˆ

### Sprint 8ï¼ˆç”Ÿäº§å‰å®¡æŸ¥ï¼‰

**1. å¼ºåˆ¶å®‰å…¨å®¡è®¡**
- é‡æ–°è¯„ä¼°æ‰€æœ‰æ¼æ´
- å†³å®šæ˜¯å¦éœ€è¦å¼ºåˆ¶ä¿®å¤æˆ–å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆ

---

## ğŸ“ å†³ç­–è®°å½•

| æ¼æ´ | ä¸¥é‡æ€§ | å†³ç­– | ç†ç”± | é‡æ–°è¯„ä¼°æ—¶é—´ |
|------|--------|------|------|--------------|
| lodash | Moderate | âœ… æ¥å—é£é™© | ADR-002 | Sprint 8 |
| tar | High | âœ… æ¥å—é£é™© | ä»…å®‰è£…é˜¶æ®µï¼Œå¯ä¿¡æº | Sprint 2-3 |
| bcrypt (é—´æ¥) | High | âœ… æ¥å—é£é™© | é—´æ¥æ¼æ´ï¼Œç­‰å¾…ä¸Šæ¸¸ä¿®å¤ | Sprint 2-3 |

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µï¼ˆå·²å®æ–½ï¼‰

âœ… **å·²å®Œæˆ**:
- ä½¿ç”¨ package-lock.json é”å®šä¾èµ–ç‰ˆæœ¬
- å¼€å‘ç¯å¢ƒéš”ç¦»ï¼ˆAzure è®¢é˜…ï¼‰
- ä»£ç å­˜å‚¨åœ¨ç§æœ‰ GitHub ä»“åº“
- éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼ˆæ•°æ®åº“ã€å­˜å‚¨ï¼‰

âœ… **Sprint 1 åç»­**:
- ç”Ÿäº§æ„å»ºä½¿ç”¨ `npm ci`ï¼ˆç²¾ç¡®å®‰è£…ï¼‰
- å®šæœŸè¿è¡Œ `npm audit`ï¼ˆæ¯å‘¨ï¼‰
- å…³æ³¨ä¸Šæ¸¸åŒ…æ›´æ–°

---

## ğŸ“ å­¦ä¹ æ€»ç»“

### Deprecated Packages vs. Security Vulnerabilities

- **Deprecated**: åŒ…ä¸å†ç»´æŠ¤ï¼Œä½†ä»å¯å·¥ä½œ â†’ ä½ä¼˜å…ˆçº§
- **Vulnerabilities**: å·²çŸ¥å®‰å…¨æ¼æ´ â†’ éœ€è¦é£é™©è¯„ä¼°

### é—´æ¥ä¾èµ–çš„æŒ‘æˆ˜

- æˆ‘ä»¬æ— æ³•ç›´æ¥æ§åˆ¶é—´æ¥ä¾èµ–ï¼ˆå¦‚ tar â† bcryptï¼‰
- éœ€è¦ç­‰å¾…ä¸Šæ¸¸åŒ…ï¼ˆbcryptï¼‰æ›´æ–°
- å¯ä»¥é€šè¿‡ `package.json` çš„ `overrides` å¼ºåˆ¶ç‰ˆæœ¬ï¼ˆé«˜çº§æŠ€å·§ï¼Œæœ‰é£é™©ï¼‰

### npm audit fix --force çš„é£é™©

- å¯èƒ½å®‰è£… breaking changes
- å¯èƒ½é™çº§åŒ…åˆ°ä¸å…¼å®¹çš„ç‰ˆæœ¬
- **æ°¸è¿œå…ˆæµ‹è¯•ï¼Œä¸è¦ç›²ç›®è¿è¡Œ**

---

## âœ… ç»“è®º

**å½“å‰çŠ¶æ€**: æ‰€æœ‰æ¼æ´é£é™©å¯æ¥å—ï¼Œæ— éœ€ç«‹å³é‡‡å–è¡ŒåŠ¨

**å»ºè®®**:
1. âœ… ç»§ç»­å¼€å‘ Story 2.3ï¼ˆJWT Loginï¼‰
2. âœ… å°†æ­¤åˆ†ææ–‡æ¡£æäº¤åˆ° Git ä»“åº“
3. âœ… åœ¨ Sprint 2 Planning æ—¶é‡æ–°è¯„ä¼°

**ä¸å»ºè®®**:
- âŒ ä¸è¦è¿è¡Œ `npm audit fix --force`ï¼ˆå¯èƒ½ç ´åç°æœ‰ä»£ç ï¼‰
- âŒ ä¸è¦æ‰‹åŠ¨å‡çº§ bcrypt åˆ° v6ï¼ˆæœªæµ‹è¯•ï¼‰
- âŒ ä¸è¦å°è¯•æ‰‹åŠ¨è¦†ç›– tar ç‰ˆæœ¬ï¼ˆå¯èƒ½å¯¼è‡´ bcrypt å®‰è£…å¤±è´¥ï¼‰

---

**ä½œè€…**: Sprint 1 Development Team  
**å®¡é˜…**: å¾… Sprint Retrospective æ—¶å®¡é˜…  
**çŠ¶æ€**: è‰ç¨¿ â†’ å¾…æ‰¹å‡†
