# Story 12.5.2: Remove Legacy `Badge.evidenceUrl` Column (D-4)

Status: Not Started

## Story

As a **Developer**,
I want to remove the legacy `evidenceUrl` column from the Badge model,
So that the schema accurately reflects the current architecture where evidence is managed via the `EvidenceFile` relation.

## Context

- **Background:** The `Badge.evidenceUrl` field was part of the original Badge model (Sprint 10). Sprint 12 introduced the `EvidenceFile` model as a proper evidence management system (files + URLs), making `evidenceUrl` redundant.
- **Current state:** The column exists in `schema.prisma` and the database but is **never read or written** by application code:
  - `badge-issuance.service.ts` builds evidence from `EvidenceFile` records (not from `Badge.evidenceUrl`)
  - `assertion-generator.service.ts` accepts `evidenceUrls[]` parameter built from `EvidenceFile` data
  - Frontend has **zero** references to `evidenceUrl`
  - `bulk-issue-badges.dto.ts` has a comment noting "evidenceUrl REMOVED — PO decision 2026-02-22"
- **Risk:** Low. Column is confirmed dead. Migration is a simple `DROP COLUMN`. No application behavior changes.

## Acceptance Criteria

1. [ ] `evidenceUrl` field removed from the `Badge` model in `schema.prisma`
2. [ ] Prisma migration generated to `ALTER TABLE "badges" DROP COLUMN "evidenceUrl"`
3. [ ] Migration runs successfully without data loss in other columns
4. [ ] All 847+ backend tests pass after removal
5. [ ] All 702+ frontend tests pass (no changes expected)
6. [ ] The stale comment in `bulk-issue-badges.dto.ts` (line 15-16) is cleaned up
7. [ ] `prisma generate` produces updated types without `evidenceUrl`

## Tasks / Subtasks

- [ ] Task 1: **Schema** — Remove `evidenceUrl String?` from Badge model in `prisma/schema.prisma` (line 204)
- [ ] Task 2: **Migration** — Run `npx prisma migrate dev --name remove-badge-evidence-url`
  - Verify generated SQL: `ALTER TABLE "badges" DROP COLUMN "evidenceUrl";`
  - Verify no other tables/columns affected
- [ ] Task 3: **Prisma Client** — Run `npx prisma generate` to regenerate types
- [ ] Task 4: **Comment cleanup** — Remove stale comment in `src/badge-issuance/dto/bulk-issue-badges.dto.ts` lines 15-16
- [ ] Task 5: **Backend tests** — Run full backend test suite, confirm no regressions
- [ ] Task 6: **Frontend tests** — Run full frontend test suite (should be no-op)
- [ ] Task 7: **Verify** — Confirm no remaining references to `Badge.evidenceUrl` (grep for the exact column usage)

## Dev Notes

### What NOT to Change
These files reference `evidenceUrls` (plural) — a **local variable / parameter** built from `EvidenceFile` records. They are NOT related to the `Badge.evidenceUrl` schema column:

| File | Why safe |
|------|----------|
| `badge-issuance.service.ts` (L144-157) | Local `evidenceUrls` array built from `created.evidenceFiles` |
| `assertion-generator.service.ts` (L60-111) | `evidenceUrls?: string[]` method parameter |
| `assertion-generator.service.spec.ts` (L145-160) | Tests the assertion generator's `evidenceUrls` parameter |

### Historical Migration
The column was created in: `prisma/migrations/20260127020604_add_badge_model/migration.sql` (line 36). This migration file is NOT modified — historical migrations must remain intact.

### Files to Modify
- `backend/prisma/schema.prisma` — remove line 204 (`evidenceUrl String?`)
- `backend/src/badge-issuance/dto/bulk-issue-badges.dto.ts` — remove lines 15-16 (stale comment)
- NEW: `backend/prisma/migrations/YYYYMMDD_remove_badge_evidence_url/migration.sql` (auto-generated)

---

**Created:** 2026-02-25  
**Source:** Sprint 12 Deferred Item D-4  
**Estimated Effort:** 1h  
**Risk:** Low — column is confirmed unused in application code
