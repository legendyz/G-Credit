# Story 12.5.1: CategoryTree Enhancements (D-1, D-2, D-3)

Status: Review

## Story

As an **Admin**,
I want the skill category tree to be responsive on smaller screens, provide clear visual feedback during drag-and-drop, and allow moving categories between levels,
So that category management works well on all devices and supports full taxonomy reorganization.

## Context

- **CategoryTree component:** `frontend/src/components/admin/CategoryTree.tsx` (488 lines)
- **DnD stack:** `@dnd-kit/core@^6.3.1`, `@dnd-kit/sortable@^10.0.0`, `@dnd-kit/utilities@^3.2.2`
- **Current DnD behavior:** Same-level reorder only (`SortableContext` per sibling group). No cross-level reparent. Visual feedback uses opacity change only.
- **Backend:** `PATCH /api/skill-categories/:id` exists but `UpdateSkillCategoryDto` has no `parentId` field — reparent endpoint not available.
- **Tree constraints:** Max 3 levels. `isSystemDefined` categories cannot be moved/deleted.
- This story resolves D-1, D-2, D-3 from Sprint 12 deferred items.

## Acceptance Criteria

### D-1: Responsive Tree→Dropdown (`<1024px`)
1. [ ] On screens `<1024px`, the tree view collapses into a dropdown selector (e.g., Shadcn `Select` with indented options)
2. [ ] Dropdown shows hierarchy visually (indent or `└` prefix for child categories)
3. [ ] All tree actions (create, edit, delete, add child) remain accessible via dropdown item context menu or toolbar buttons
4. [ ] DnD reorder is disabled on small screens (reorder via manual "move up/down" buttons or not available — acceptable trade-off for mobile)
5. [ ] Breakpoint uses Tailwind responsive: `lg:` prefix or `useMediaQuery` hook

### D-2: Blue Insertion Line (DnD Visual Feedback)
6. [ ] During drag, a blue horizontal line (2px, `border-blue-500`) appears at the insertion point between nodes
7. [ ] The insertion line accurately indicates where the dragged item will be placed when dropped
8. [ ] The current opacity-based feedback is replaced or supplemented with the insertion line
9. [ ] Insertion line only appears between valid drop targets (same-level siblings)

### D-3: Cross-Level "Move to..." Action
10. [ ] Each tree node (in editable mode) has a "Move to..." action button (or context menu item)
11. [ ] Clicking "Move to..." opens a dialog showing the full category tree (read-only mode) as target selector
12. [ ] Admin selects a target parent category (or "Root" for Level 1)
13. [ ] Target category must not be the node itself or any of its descendants (cycle prevention)
14. [ ] Moving a category recalculates its `level` (and all children's levels recursively)
15. [ ] Moving between levels fails if the result would exceed max depth 3 (e.g., moving a Level 2 with Level 3 children under another Level 2)
16. [ ] `isSystemDefined` categories cannot be moved (button disabled with tooltip)
17. [ ] Backend reparent endpoint validates: category exists, parent exists (or null for root), no cycles, depth ≤ 3

## Tasks / Subtasks

### D-1: Responsive (Frontend Only)
- [x] Task 1: Add `useMediaQuery` hook (or use existing) for `<1024px` breakpoint
- [x] Task 2: Create `<CategoryDropdown>` component as responsive alternative
  - [x] Render as `<Select>` with indented option labels (`"└ Frontend Development"`)
  - [x] Wire same `onSelect` callback as tree mode
  - [x] Show toolbar buttons for create/edit/delete actions on selected item
- [x] Task 3: In `<CategoryTree>`, conditionally render `<CategoryDropdown>` when `< lg` breakpoint
- [x] Task 4: Tests — responsive behavior, dropdown rendering, action accessibility

### D-2: Blue Insertion Line (Frontend Only)
- [x] Task 5: Implement `DragOverlay` from `@dnd-kit/core` for visual clone during drag
- [x] Task 6: Track active drop position and render insertion indicator line
  - [x] Use `onDragOver` event to detect current insertion index
  - [x] Render `<div className="h-0.5 bg-blue-500 rounded-full mx-2" />` at insertion point
- [x] Task 7: Remove or reduce opacity overlay (keep subtle opacity as secondary cue)
- [x] Task 8: Tests — insertion line appears during drag, correct position

### D-3: Cross-Level Move (Backend + Frontend)
- [x] Task 9: **Backend** — Add `parentId` to `UpdateSkillCategoryDto`
  - [x] New field: `@IsOptional() @IsUUID() parentId?: string | null`
  - [x] `null` means move to root (Level 1)
- [x] Task 10: **Backend** — Add reparent logic in `skill-categories.service.ts` `update()` method
  - [x] Detect when `parentId` changes from current value
  - [x] Validate: target parent exists (or null for root)
  - [x] Validate: target is not self or any descendant (cycle detection — recursive check)
  - [x] Validate: resulting depth ≤ 3 (category depth + max child depth of moved subtree)
  - [x] Validate: `isSystemDefined` cannot be moved (403)
  - [x] Recalculate `level` for the moved category and all descendants (recursive update)
  - [x] Set `displayOrder` to append at end of new parent's children
- [x] Task 11: **Backend** — Tests for reparent logic
  - [x] Move L2→L1 (success)
  - [x] Move L1→L2 under another parent (success)
  - [x] Move to self (400)
  - [x] Move to descendant (400 — cycle)
  - [x] Move causing depth >3 (400)
  - [x] Move `isSystemDefined` (403)
  - [x] Move to non-existent parent (404)
- [x] Task 12: **Frontend** — Create `<MoveToDialog>` component
  - [x] Shows target list for parent selection with disabled constraints
  - [x] Add "Root (Level 1)" option at top
  - [x] Disable current parent, self, and all descendants in the tree
  - [x] Confirm button: calls `PATCH /api/skill-categories/:id` with new `parentId`
  - [x] Invalidate `['skill-categories']` query cache on success
- [x] Task 13: **Frontend** — Add "Move to..." button in `CategoryTreeNodeInner`
  - [x] Icon: `FolderInput` from Lucide
  - [x] Hidden for `isSystemDefined` categories
  - [x] Hidden when `editable={false}`
- [x] Task 14: **Frontend** — Tests for MoveToDialog and integration

## Dev Notes

### Architecture Patterns
- Reuse existing `<CategoryTree>` in read-only mode inside `<MoveToDialog>`
- Backend reparent is an extension of existing `PATCH` endpoint — not a separate route
- Cycle detection: load category with descendants, check if targetParentId is in that subtree
- Level recalculation: `newLevel = parentLevel + 1` (or `1` if root), then recursive update children

### Depth Validation Formula
```
maxAllowedDepth = 3
currentSubtreeDepth = maxDescendantLevel - categoryLevel
newLevel = (newParent ? newParent.level + 1 : 1)
if (newLevel + currentSubtreeDepth > maxAllowedDepth) → reject
```

### Files to Modify
- `frontend/src/components/admin/CategoryTree.tsx` — responsive toggle, insertion line, move button
- `frontend/src/components/admin/CategoryDropdown.tsx` — NEW file (responsive dropdown)
- `frontend/src/components/admin/MoveToDialog.tsx` — NEW file
- `backend/src/skill-categories/dto/skill-category.dto.ts` — add `parentId` to UpdateDto
- `backend/src/skill-categories/skill-categories.service.ts` — reparent logic
- `backend/src/skill-categories/skill-categories.service.spec.ts` — reparent tests

### Existing Test Count Reference
- Backend: 847 tests (28 skipped = TD-006)
- Frontend: 702 tests (66 files)
- CategoryTree existing tests: in `CategoryTree.test.tsx`

---

**Created:** 2026-02-25  
**Source:** Sprint 12 Deferred Items D-1, D-2, D-3  
**Estimated Effort:** 6h (D-1: ~2h, D-2: ~1h, D-3: ~3h)
