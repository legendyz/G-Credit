// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ISSUER
  MANAGER
  EMPLOYEE
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  role          UserRole  @default(EMPLOYEE)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
  badgeTemplates      BadgeTemplate[]
  badgesReceived      Badge[]           @relation("BadgesReceived")
  badgesIssued        Badge[]           @relation("BadgesIssued")

  @@index([email])
  @@index([role])
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

// Sprint 2: Badge Template Management Models

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// Sprint 3: Badge Issuance Models

enum BadgeStatus {
  PENDING   // Awaiting claim
  CLAIMED   // Claimed by recipient
  EXPIRED   // Past expiration date
  REVOKED   // Revoked by admin
}

model BadgeTemplate {
  id               String         @id @default(uuid())
  name             String         @db.VarChar(100)
  description      String?        @db.Text
  imageUrl         String?        // Azure Blob Storage URL
  category         String         @db.VarChar(50)
  skillIds         String[]       // Array of Skill IDs
  issuanceCriteria Json           // Flexible JSON structure for criteria
  validityPeriod   Int?           // Validity period in days, null = permanent
  status           TemplateStatus @default(DRAFT)
  createdBy        String
  creator          User           @relation(fields: [createdBy], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  badges           Badge[]        // Badges issued from this template

  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@index([createdBy])
  @@index([category, status]) // Composite index for filtering by category + status
  @@index([status, createdAt]) // Composite index for status + sorting
  @@map("badge_templates")
}

model SkillCategory {
  id              String           @id @default(uuid())
  name            String           @db.VarChar(100)
  nameEn          String?          @db.VarChar(100) // English name
  description     String?          @db.Text
  parentId        String?
  parent          SkillCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        SkillCategory[]  @relation("CategoryHierarchy")
  level           Int              @default(1) // 1=top, 2=second, 3=third
  isSystemDefined Boolean          @default(false) // true=preset, false=custom
  isEditable      Boolean          @default(true)
  displayOrder    Int              @default(0)
  skills          Skill[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([parentId])
  @@index([isSystemDefined])
  @@index([level])
  @@map("skill_categories")
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Skill {
  id          String        @id @default(uuid())
  name        String        @db.VarChar(100)
  description String?       @db.Text
  categoryId  String
  category    SkillCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  level       SkillLevel?   // Optional skill level
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([name, categoryId]) // Unique skill name per category
  @@index([categoryId])
  @@map("skills")
}

model Badge {
  id               String        @id @default(uuid())
  templateId       String
  recipientId      String
  issuerId         String
  evidenceUrl      String?       // Azure Blob Storage URL
  issuedAt         DateTime      @default(now())
  expiresAt        DateTime?     // Calculated from expiresIn
  status           BadgeStatus   @default(PENDING)
  claimToken       String?       @unique // 32-char token
  claimedAt        DateTime?
  revokedAt        DateTime?
  revocationReason String?       @db.Text
  assertionJson    Json          // Open Badges 2.0 JSON-LD
  recipientHash    String        // SHA-256(email + salt)
  
  template         BadgeTemplate @relation(fields: [templateId], references: [id])
  recipient        User          @relation("BadgesReceived", fields: [recipientId], references: [id])
  issuer           User          @relation("BadgesIssued", fields: [issuerId], references: [id])
  
  @@index([recipientId, status])
  @@index([templateId, issuedAt])
  @@index([claimToken])
  @@index([status, expiresAt])
  @@index([issuerId])
  @@map("badges")
}
