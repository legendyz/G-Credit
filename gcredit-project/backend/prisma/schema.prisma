generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model badge_templates {
  id               String         @id
  name             String         @db.VarChar(100)
  description      String?
  imageUrl         String?
  category         String         @db.VarChar(50)
  skillIds         String[]
  issuanceCriteria Json
  validityPeriod   Int?
  status           TemplateStatus @default(DRAFT)
  createdBy        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  users            users          @relation(fields: [createdBy], references: [id])
  badges           badges[]

  @@index([category])
  @@index([category, status])
  @@index([createdAt])
  @@index([createdBy])
  @@index([status, createdAt])
  @@index([status])
}

model badges {
  id                              String           @id
  templateId                      String
  recipientId                     String
  issuerId                        String
  evidenceUrl                     String?
  issuedAt                        DateTime         @default(now())
  expiresAt                       DateTime?
  status                          BadgeStatus      @default(PENDING)
  claimToken                      String?          @unique
  claimedAt                       DateTime?
  revokedAt                       DateTime?
  revocationReason                String?
  assertionJson                   Json
  recipientHash                   String
  metadataHash                    String?
  verificationId                  String           @unique
  users_badges_issuerIdTousers    users            @relation("badges_issuerIdTousers", fields: [issuerId], references: [id])
  users_badges_recipientIdTousers users            @relation("badges_recipientIdTousers", fields: [recipientId], references: [id])
  badge_templates                 badge_templates  @relation(fields: [templateId], references: [id])
  evidence_files                  evidence_files[]

  @@index([claimToken])
  @@index([issuerId])
  @@index([recipientId, status])
  @@index([status, expiresAt])
  @@index([templateId, issuedAt])
  @@index([verificationId])
  @@index([recipientId, status, issuedAt(sort: Desc)], map: "idx_badges_timeline")
}

model evidence_files {
  id           String   @id
  badgeId      String
  fileName     String   @db.VarChar(255)
  originalName String   @db.VarChar(255)
  fileSize     Int
  mimeType     String   @db.VarChar(100)
  blobUrl      String
  uploadedBy   String
  uploadedAt   DateTime @default(now())
  badges       badges   @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  users        users    @relation(fields: [uploadedBy], references: [id])

  @@index([badgeId])
}

model milestone_achievements {
  id                String            @id
  milestoneId       String
  userId            String
  achievedAt        DateTime          @default(now())
  milestone_configs milestone_configs @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  users             users             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([milestoneId, userId])
  @@index([userId, achievedAt])
}

model milestone_configs {
  id                     String                   @id
  type                   MilestoneType
  title                  String                   @db.VarChar(200)
  description            String
  trigger                Json
  icon                   String                   @db.VarChar(10)
  isActive               Boolean                  @default(true)
  createdBy              String
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  milestone_achievements milestone_achievements[]
  users                  users                    @relation(fields: [createdBy], references: [id])

  @@index([isActive])
}

model password_reset_tokens {
  id        String   @id
  token     String   @unique
  userId    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model refresh_tokens {
  id        String   @id
  token     String   @unique
  userId    String
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model skill_categories {
  id                     String             @id
  name                   String             @db.VarChar(100)
  nameEn                 String?            @db.VarChar(100)
  description            String?
  parentId               String?
  level                  Int                @default(1)
  isSystemDefined        Boolean            @default(false)
  isEditable             Boolean            @default(true)
  displayOrder           Int                @default(0)
  createdAt              DateTime           @default(now())
  updatedAt              DateTime
  skill_categories       skill_categories?  @relation("skill_categoriesToskill_categories", fields: [parentId], references: [id], onDelete: Cascade)
  other_skill_categories skill_categories[] @relation("skill_categoriesToskill_categories")
  skills                 skills[]

  @@index([isSystemDefined])
  @@index([level])
  @@index([parentId])
}

model skills {
  id               String           @id
  name             String           @db.VarChar(100)
  description      String?
  categoryId       String
  level            SkillLevel?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  skill_categories skill_categories @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([name, categoryId])
  @@index([categoryId])
}

model users {
  id                               String                   @id
  email                            String                   @unique
  role                             UserRole                 @default(EMPLOYEE)
  createdAt                        DateTime                 @default(now())
  updatedAt                        DateTime
  emailVerified                    Boolean                  @default(false)
  firstName                        String?
  isActive                         Boolean                  @default(true)
  lastLoginAt                      DateTime?
  lastName                         String?
  passwordHash                     String
  badge_templates                  badge_templates[]
  badges_badges_issuerIdTousers    badges[]                 @relation("badges_issuerIdTousers")
  badges_badges_recipientIdTousers badges[]                 @relation("badges_recipientIdTousers")
  evidence_files                   evidence_files[]
  milestone_achievements           milestone_achievements[]
  milestone_configs                milestone_configs[]
  password_reset_tokens            password_reset_tokens[]
  refresh_tokens                   refresh_tokens[]

  @@index([email])
  @@index([role])
}

enum BadgeStatus {
  PENDING
  CLAIMED
  EXPIRED
  REVOKED
}

enum MilestoneType {
  BADGE_COUNT
  SKILL_TRACK
  ANNIVERSARY
  CUSTOM
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  ADMIN
  ISSUER
  MANAGER
  EMPLOYEE
}
