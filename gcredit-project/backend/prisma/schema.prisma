// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ISSUER
  MANAGER
  EMPLOYEE
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  department    String?   // Sprint 8: M365 sync field
  role          UserRole  @default(EMPLOYEE)
  azureId       String?   @unique // Sprint 8: M365 Azure AD ID
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLoginAt   DateTime?
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Story 8.10: Admin User Management
  roleSetManually Boolean   @default(false) // True if Admin manually set role
  roleUpdatedAt   DateTime? // When role was last updated
  roleUpdatedBy   String?   // Admin user ID who updated role
  roleVersion     Int       @default(0) // Optimistic locking for role changes
  lastSyncAt      DateTime? // Last M365 sync timestamp

  passwordResetTokens   PasswordResetToken[]
  refreshTokens         RefreshToken[]
  badgeTemplates        BadgeTemplate[]        @relation("TemplateCreator")
  badgeTemplatesUpdated BadgeTemplate[]         @relation("TemplateUpdater")
  badgesReceived        Badge[]                @relation("BadgesReceived")
  badgesIssued          Badge[]                @relation("BadgesIssued")
  badgesRevoked         Badge[]                @relation("RevokedBadges")
  milestonesCreated     MilestoneConfig[]      @relation("MilestoneCreator")
  milestoneAchievements MilestoneAchievement[] @relation("MilestoneAchievements")
  evidenceUploads       EvidenceFile[]         @relation("EvidenceUploader")

  // Story 8.10: User Audit Log relations
  auditLogsTarget    UserRoleAuditLog[] @relation("AuditTarget")
  auditLogsPerformer UserRoleAuditLog[] @relation("AuditPerformer")

  // Sprint 9: Bulk Issuance sessions
  bulkIssuanceSessions BulkIssuanceSession[] @relation("BulkIssuanceSessions")

  @@index([email])
  @@index([role])
  @@index([azureId])
  @@index([isActive])
  @@index([roleUpdatedAt])
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

// Sprint 2: Badge Template Management Models

enum TemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// Sprint 3: Badge Issuance Models

enum BadgeStatus {
  PENDING   // Awaiting claim
  CLAIMED   // Claimed by recipient
  EXPIRED   // Past expiration date
  REVOKED   // Revoked by admin
}

enum BadgeVisibility {
  PUBLIC
  PRIVATE
}

model BadgeTemplate {
  id               String         @id @default(uuid())
  name             String         @db.VarChar(100)
  description      String?        @db.Text
  imageUrl         String?        // Azure Blob Storage URL
  category         String         @db.VarChar(50)
  skillIds         String[]       // Array of Skill IDs
  issuanceCriteria Json           // Flexible JSON structure for criteria
  validityPeriod   Int?           // Validity period in days, null = permanent
  status           TemplateStatus @default(DRAFT)
  createdBy        String
  creator          User           @relation("TemplateCreator", fields: [createdBy], references: [id])
  updatedBy        String?
  updater          User?          @relation("TemplateUpdater", fields: [updatedBy], references: [id])
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  badges           Badge[]        // Badges issued from this template

  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@index([createdBy])
  @@index([updatedBy])
  @@index([category, status]) // Composite index for filtering by category + status
  @@index([status, createdAt]) // Composite index for status + sorting
  @@map("badge_templates")
}

model SkillCategory {
  id              String           @id @default(uuid())
  name            String           @db.VarChar(100)
  nameEn          String?          @db.VarChar(100) // English name
  description     String?          @db.Text
  parentId        String?
  parent          SkillCategory?   @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        SkillCategory[]  @relation("CategoryHierarchy")
  level           Int              @default(1) // 1=top, 2=second, 3=third
  isSystemDefined Boolean          @default(false) // true=preset, false=custom
  isEditable      Boolean          @default(true)
  displayOrder    Int              @default(0)
  skills          Skill[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([parentId])
  @@index([isSystemDefined])
  @@index([level])
  @@map("skill_categories")
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model Skill {
  id          String        @id @default(uuid())
  name        String        @db.VarChar(100)
  description String?       @db.Text
  categoryId  String
  category    SkillCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  level       SkillLevel?   // Optional skill level
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([name, categoryId]) // Unique skill name per category
  @@index([categoryId])
  @@map("skills")
}

model Badge {
  id               String        @id @default(uuid())
  templateId       String
  recipientId      String
  issuerId         String
  evidenceUrl      String?       // Azure Blob Storage URL
  issuedAt         DateTime      @default(now())
  expiresAt        DateTime?     // Calculated from expiresIn
  status           BadgeStatus   @default(PENDING)
  visibility       BadgeVisibility @default(PUBLIC)
  claimToken       String?       @unique // 32-char token
  claimedAt        DateTime?
  
  // Sprint 7: Revocation fields (Epic 9)
  revokedAt        DateTime?
  revokedBy        String?
  revocationReason String?       @db.Text
  revocationNotes  String?       @db.Text
  
  assertionJson    Json          // Open Badges 2.0 JSON-LD
  recipientHash    String        // SHA-256(email + salt)
  
  // Sprint 5: Badge Verification Fields
  verificationId   String        @unique @default(uuid()) // Public verification UUID
  metadataHash     String?       // SHA-256 hash of JSON-LD assertion for integrity
  
  template         BadgeTemplate @relation(fields: [templateId], references: [id])
  recipient        User          @relation("BadgesReceived", fields: [recipientId], references: [id])
  issuer           User          @relation("BadgesIssued", fields: [issuerId], references: [id])
  revoker          User?         @relation("RevokedBadges", fields: [revokedBy], references: [id])
  evidenceFiles    EvidenceFile[]
  shares           BadgeShare[]  // Sprint 6: Badge sharing analytics
  
  @@index([recipientId, status])
  @@index([templateId, issuedAt])
  @@index([claimToken])
  @@index([status, expiresAt])
  @@index([issuerId])
  @@index([verificationId]) // Sprint 5: Fast public verification lookup
  @@index([recipientId, status, issuedAt(sort: Desc)], name: "idx_badges_timeline") // Timeline view optimization
  @@index([revokedAt]) // Sprint 7: Admin reporting queries
  @@index([visibility, status])       // Sprint 11: Verification page query optimization
  @@index([recipientId, visibility])  // Sprint 11: Profile visibility filtering
  @@map("badges")
}

// Sprint 4: Milestone System Models

enum MilestoneType {
  BADGE_COUNT
  SKILL_TRACK
  ANNIVERSARY
  CUSTOM
}

model MilestoneConfig {
  id           String        @id @default(uuid())
  type         MilestoneType
  title        String        @db.VarChar(200)
  description  String        @db.Text
  trigger      Json          // JSONB trigger config
  icon         String        @db.VarChar(10) // Emoji
  isActive     Boolean       @default(true)
  createdBy    String
  creator      User          @relation("MilestoneCreator", fields: [createdBy], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  achievements MilestoneAchievement[]

  @@index([isActive])
  @@map("milestone_configs")
}

model MilestoneAchievement {
  id          String          @id @default(uuid())
  milestoneId String
  userId      String
  achievedAt  DateTime        @default(now())
  
  milestone   MilestoneConfig @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  user        User            @relation("MilestoneAchievements", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([milestoneId, userId]) // One achievement per user per milestone
  @@index([userId, achievedAt])
  @@map("milestone_achievements")
}

// Sprint 4: Evidence File Management

model EvidenceFile {
  id           String   @id @default(uuid())
  badgeId      String
  fileName     String   @db.VarChar(255)
  originalName String   @db.VarChar(255)
  fileSize     Int      // Bytes
  mimeType     String   @db.VarChar(100)
  blobUrl      String   @db.Text // Azure Blob URL
  uploadedBy   String
  uploadedAt   DateTime @default(now())
  
  badge        Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  uploader     User     @relation("EvidenceUploader", fields: [uploadedBy], references: [id])

  @@index([badgeId])
  @@map("evidence_files")
}

// Sprint 6: Badge Sharing Analytics (Story 7.5)

model BadgeShare {
  id             String   @id @default(uuid())
  badgeId        String
  badge          Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  platform       String   @db.VarChar(50) // 'email', 'teams', 'widget'
  sharedAt       DateTime @default(now())
  sharedBy       String?  // User ID who shared (nullable for anonymous widget embeds)
  
  // Platform-specific fields
  recipientEmail String?  @db.VarChar(255) // For email shares
  metadata       Json?    // For Teams (team/channel IDs), Widget (referrer URL)
  
  @@index([badgeId, platform])
  @@index([sharedAt])
  @@map("badge_shares")
}

// Sprint 7: Audit Log (Epic 9 - Badge Revocation)

model AuditLog {
  id          String   @id @default(uuid())
  entityType  String   @db.VarChar(50) // "Badge", "Template", "User"
  entityId    String   @db.VarChar(255) // Badge ID, Template ID, etc.
  action      String   @db.VarChar(50) // "REVOKED", "ISSUED", "CLAIMED"
  actorId     String   // User who performed action
  actorEmail  String?  @db.VarChar(255) // For audit trail
  timestamp   DateTime @default(now())
  metadata    Json?    // Flexible storage: { reason, notes, oldStatus, newStatus }
  
  // Indexes for efficient querying
  @@index([entityType, entityId]) // Find all actions on a badge
  @@index([actorId]) // Find all actions by a user
  @@index([timestamp]) // Time-based reports
  @@index([action]) // Filter by action type
  @@map("audit_logs")
}

// Sprint 8: M365 Sync Logging (Story 8.9)

model M365SyncLog {
  id           String   @id @default(uuid())
  syncDate     DateTime @default(now())
  syncType     String   @default("FULL") @db.VarChar(20) // 'FULL' | 'INCREMENTAL'
  userCount    Int      // Total users in M365
  syncedCount  Int      // Successfully synced users
  createdCount Int      @default(0) // New users created
  updatedCount Int      @default(0) // Existing users updated
  failedCount  Int      @default(0) // Users that failed to sync (AC3)
  status       String   @db.VarChar(20) // 'SUCCESS' | 'PARTIAL_SUCCESS' | 'FAILURE'
  errorMessage String?  @db.Text
  durationMs   Int?     // Sync duration in milliseconds
  syncedBy     String?  @db.VarChar(100) // Who triggered the sync (AC3)
  metadata     Json?    // Retry info, pagination, etc. (AC3)
  createdAt    DateTime @default(now())

  @@index([syncDate])
  @@index([status])
  @@map("m365_sync_logs")
}

// Sprint 8: User Audit Log (Story 8.9)

model UserAuditLog {
  id         String   @id @default(uuid())
  userId     String   // User being audited
  action     String   @db.VarChar(50) // 'CREATED', 'UPDATED', 'DEACTIVATED', 'REACTIVATED'
  changes    Json?    // Field changes: { field: { old, new } }
  source     String   @db.VarChar(20) // 'M365_SYNC', 'MANUAL', 'SYSTEM'
  actorId    String?  // User who made the change (null for system)
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
  @@index([action])
  @@map("user_audit_logs")
}

// Sprint 8: User Role Audit Log (Story 8.10)
// Separate table for Admin-driven role/status changes with proper relations

model UserRoleAuditLog {
  id          String   @id @default(uuid())
  userId      String   // Target user
  performedBy String   // Admin who made the change
  action      String   @db.VarChar(50) // 'ROLE_CHANGED' | 'STATUS_CHANGED'
  oldValue    String?  @db.VarChar(50) // Old role or status
  newValue    String   @db.VarChar(50) // New role or status
  note        String?  @db.Text // Admin's note
  createdAt   DateTime @default(now())

  user  User @relation("AuditTarget", fields: [userId], references: [id], onDelete: Cascade)
  admin User @relation("AuditPerformer", fields: [performedBy], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([performedBy])
  @@index([createdAt])
  @@map("user_role_audit_logs")
}

// Sprint 9: Bulk Issuance Session (Story 8.2)
// Stores validated CSV upload sessions for preview/confirm workflow
model BulkIssuanceSession {
  id         String   @id @default(uuid())
  issuerId   String
  status     String   @db.VarChar(20) // PENDING, VALIDATED, PROCESSING, COMPLETED, FAILED, EXPIRED
  validRows  Json     @default("[]") // JSONB array of validated row objects
  totalRows  Int      @default(0)
  validCount Int      @default(0)
  errorCount Int      @default(0)
  errors     Json     @default("[]") // JSONB array of SessionError objects
  rows       Json     @default("[]") // JSONB array of preview row data
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  issuer User @relation("BulkIssuanceSessions", fields: [issuerId], references: [id], onDelete: Cascade)

  @@index([issuerId])
  @@index([expiresAt])
  @@index([status])
  @@map("bulk_issuance_sessions")
}
