echo "Running pre-push checks (mirroring CI pipeline)..."

set -e

# Backend checks
echo "=== Backend ==="
cd gcredit-project/backend
npx eslint src/ --max-warnings=0
npx tsc --noEmit
# Jest --forceExit returns exit code 1 even when all tests pass (open handles).
# Parse the summary line to determine actual pass/fail status.
TEST_OUTPUT=$(npm test -- --forceExit 2>&1) || true
echo "$TEST_OUTPUT" | tail -20
if echo "$TEST_OUTPUT" | grep -q "Test Suites:.*failed"; then
  echo "❌ Backend tests failed"
  exit 1
fi
echo "✓ Backend tests passed"
cd ../..

# Frontend checks
echo "=== Frontend ==="
cd gcredit-project/frontend
npx eslint src/ --max-warnings=0
npx tsc -p tsconfig.app.json --noEmit
npx vitest run
cd ../..

echo "✓ All pre-push checks passed!"
