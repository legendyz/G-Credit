echo "Running pre-push checks (mirroring CI pipeline)..."

# Skip checks for tag pushes (no code changes to validate)
# Git sends "<local ref> <local sha> <remote ref> <remote sha>" lines via stdin.
TAG_PUSH=false
while read local_ref local_sha remote_ref remote_sha; do
  if echo "$local_ref" | grep -q "^refs/tags/"; then
    TAG_PUSH=true
  fi
done
if [ "$TAG_PUSH" = "true" ]; then
  echo "Tag push detected — skipping pre-push checks"
  exit 0
fi

set -e

# ===========================================
# Backend checks (mirrors CI: lint-and-unit + build)
# ===========================================
echo "=== Backend ==="
cd gcredit-project/backend

# 1. ESLint — match CI: npm run lint (covers src + test)
npm run lint

# 2. TypeScript — same as CI
npx tsc --noEmit

# 3. Unit Tests — match CI flags
# Jest --forceExit returns exit code 1 even when all tests pass (open handles).
# CI uses --passWithNoTests --coverage, we skip coverage locally for speed.
TEST_OUTPUT=$(npm test -- --passWithNoTests --forceExit 2>&1) || true
echo "$TEST_OUTPUT" | tail -20

# Defensive check: require a summary line to exist (guards against Jest crash/hang
# producing no output, which would silently pass the grep-based check below).
if ! echo "$TEST_OUTPUT" | grep -q "Test Suites:"; then
  echo "❌ Backend tests: no summary line found (Jest may have crashed)"
  exit 1
fi
if echo "$TEST_OUTPUT" | grep -q "Test Suites:.*failed"; then
  echo "❌ Backend tests failed"
  exit 1
fi
echo "✓ Backend tests passed"

# 4. Build — match CI: nest build
npm run build
echo "✓ Backend build passed"

cd ../..

# ===========================================
# Frontend checks (mirrors CI: frontend-tests + frontend-build)
# ===========================================
echo "=== Frontend ==="
cd gcredit-project/frontend

# 1. ESLint — match CI: npm run lint (covers all files)
npm run lint

# 2. Frontend Tests
# Vitest in sh -e on Windows can occasionally exit early (worker race).
# Capture output and check the summary line, same pattern as backend Jest.
VITEST_OUTPUT=$(npx vitest run 2>&1) || true
echo "$VITEST_OUTPUT" | tail -10

if ! echo "$VITEST_OUTPUT" | grep -q "Test Files"; then
  echo "❌ Frontend tests: no summary line found (Vitest may have crashed)"
  exit 1
fi
if echo "$VITEST_OUTPUT" | grep -q "Test Files.*failed"; then
  echo "❌ Frontend tests failed"
  exit 1
fi
# Guard against "0 passed" (worker race — tests discovered but not executed)
if echo "$VITEST_OUTPUT" | grep -q "Test Files  0 passed"; then
  echo "❌ Frontend tests: 0 tests executed (possible worker race). Re-run push."
  exit 1
fi
echo "✓ Frontend tests passed"

# 3. Build (tsc -b + vite build) — match CI: npm run build
npm run build
echo "✓ Frontend build passed"

cd ../..

# Note: Chinese character check and E2E tests are CI-only
# (E2E requires Postgres container, chinese check is supplementary)

echo "✓ All pre-push checks passed!"
